<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Книга Заклинаний - Игра</title>
    <!-- Подключаем Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Шапка */
        .header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4a5568;
        }
        
        .logo span {
            color: #667eea;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-icon, .spells-icon {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .home-icon {
            background: none;
            color: #33228c;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: none;
            position: relative;
            font-size: 1.2rem;
        }
        
        .spells-icon {
            background: #357692;
        }
        
        .user-icon:hover, .spells-icon:hover, .home-icon:hover {
            transform: scale(1.05);
        }
        
        .username {
            font-weight: 500;
            color: #4a5568;
        }
        
        /* Основное содержимое */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .section-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .section-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .spells-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .spells-container {
                grid-template-columns: 1fr;
            }
        }
        
        .spells-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .section-name {
            font-size: 1.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        
        .section-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .spells-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .spell-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .spell-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .spell-card.learned {
            border-left: 4px solid #4CAF50;
        }
        
        .spell-card.available {
            border-left: 4px solid #FF9800;
        }
        
        .spell-card.on-cooldown {
            border-left: 4px solid #9e9e9e;
            opacity: 0.7;
            background: #f5f5f5;
        }
        
        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .spell-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .spell-level {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .spell-desc {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .spell-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .spell-stat {
            background: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .spell-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 15px;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }
        
        .spell-details.active {
            max-height: 500px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .detail-label {
            font-weight: 500;
            color: #4a5568;
        }
        
        .detail-value {
            color: #718096;
        }
        
        .learn-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }
        
        .learn-button:hover {
            background: #45a049;
        }
        
        .learn-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .forget-button {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }
        
        .forget-button:hover {
            background: #d32f2f;
        }
        
        .spell-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .spell-actions .learn-button,
        .spell-actions .forget-button {
            margin-top: 0;
            width: auto;
            flex: 1;
        }
        
        .spell-cooldown {
            background: #ff9800;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .loading {
            padding: 40px;
            color: #666;
            text-align: center;
            background: white;
            border-radius: 15px;
            margin: 20px;
        }
        
        .error {
            padding: 40px;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            text-align: center;
            margin: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #cbd5e0;
        }
        
        .spell-limit-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 0.9rem;
        }
        
        .spell-limit-info.warning {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .spell-limit-info strong {
            color: #5d4e02;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .username {
                display: none;
            }
            
            .spells-grid {
                grid-template-columns: 1fr;
            }
            
            .spell-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="header">
        <div class="logo">Игра<span>Мир</span></div>
        <div class="user-menu">
            <span class="username" id="username-header">Загрузка...</span>
            <div class="home-icon" id="home-icon" title="На главную">
                <i class="fa-solid fa-house" style="color: #33228c;"></i>
            </div>
            <div class="spells-icon" id="spells-icon">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <div class="user-icon" id="user-icon">
                <i class="fa-solid fa-user"></i>
            </div>
        </div>
    </header>

    <!-- Основное содержимое -->
    <div class="container">
        <div id="loading" class="loading">
            <h2>Загрузка заклинаний...</h2>
            <p>Пожалуйста, подождите, загружаем вашу книгу заклинаний.</p>
        </div>
        
        <div id="content" style="display: none;">
            <h1 class="section-title">Книга Заклинаний</h1>
            <p class="section-subtitle">
                Изучайте новые заклинания и управляйте уже изученными. Каждое заклинание имеет уникальные свойства и требует определенного уровня для изучения.
            </p>
            
            <div class="spells-container">
                <!-- Изученные заклинания -->
                <div class="spells-section">
                    <div class="section-header">
                        <div class="section-name">Ваши заклинания</div>
                        <div class="section-count" id="learned-count">0</div>
                    </div>
                    
                    <div class="spell-limit-info" id="spell-limit-info" style="display: none;">
                        <i class="fa-solid fa-info-circle"></i> 
                        Уровень <strong id="user-level">1</strong>: 
                        Вы изучили <strong id="current-spells">0</strong> из <strong id="max-spells">0</strong> доступных слотов заклинаний. 
                        Забывайте ненужные заклинания, чтобы освободить место для новых.
                    </div>
                    
                    <div class="spells-grid" id="learned-spells">
                        <!-- Изученные заклинания будут загружены здесь -->
                    </div>
                    
                    <div id="no-learned-spells" class="empty-state" style="display: none;">
                        <i class="fa-solid fa-book"></i>
                        <h3>Нет изученных заклинаний</h3>
                        <p>Изучите заклинания из доступных, чтобы они появились здесь.</p>
                    </div>
                </div>
                
                <!-- Доступные заклинания -->
                <div class="spells-section">
                    <div class="section-header">
                        <div class="section-name">Доступные для изучения</div>
                        <div class="section-count" id="available-count">0</div>
                    </div>
                    
                    <div class="spells-grid" id="available-spells">
                        <!-- Доступные заклинания будут загружены здесь -->
                    </div>
                    
                    <div id="no-available-spells" class="empty-state" style="display: none;">
                        <i class="fa-solid fa-lock"></i>
                        <h3>Нет доступных заклинаний</h3>
                        <p>Повысьте уровень, чтобы открыть новые заклинания.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <h2>Ошибка загрузки</h2>
            <p>Не удалось загрузить данные о заклинаниях.</p>
            <p>Попробуйте <a href="javascript:location.reload()">обновить страницу</a> или <a href="home.html">вернуться на главную</a>.</p>
        </div>
    </div>

    <script>
        let sessionToken = null;
        let currentUser = null;
        let userStats = null;
        let learnedSpells = [];
        let availableSpells = [];
        let spellSlotsInfo = null;

        // Получаем токен сессии из localStorage
        function getSessionToken() {
            return localStorage.getItem('session_token');
        }

        // Проверяем валидность сессии
        async function verifySession(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/session/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.valid ? data.user_id : null;
                }
                return null;
            } catch (error) {
                console.error('Session verification error:', error);
                return null;
            }
        }

        // Загружаем данные пользователя
        async function loadUserData(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('User data loading error:', error);
                return null;
            }
        }

        // Загружаем статистику пользователя
        async function loadUserStats(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.exists ? data.stats : null;
                }
                return null;
            } catch (error) {
                console.error('User stats loading error:', error);
                return null;
            }
        }

        // Загружаем изученные заклинания
        async function loadLearnedSpells(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/spells', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.success ? data.spells : [];
                }
                return [];
            } catch (error) {
                console.error('Learned spells loading error:', error);
                return [];
            }
        }

        // Загружаем доступные заклинания
        async function loadAvailableSpells(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/spells/available', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.success ? data.available_spells : [];
                }
                return [];
            } catch (error) {
                console.error('Available spells loading error:', error);
                return [];
            }
        }

        // Загружаем информацию о слотах заклинаний
        async function loadSpellSlotsInfo(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/spell-slots', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
                return null;
            } catch (error) {
                console.error('Spell slots info loading error:', error);
                return null;
            }
        }

        // Изучение нового заклинания
        async function learnSpell(spellId) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/learn-spell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ spell_id: spellId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    const errorData = await response.json();
                    return errorData;
                }
            } catch (error) {
                console.error('Learn spell error:', error);
                return { success: false, error: 'Network error' };
            }
        }

        // Забытие заклинания
        async function forgetSpell(spellId) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/forget-spell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ spell_id: spellId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    const errorData = await response.json();
                    return errorData;
                }
            } catch (error) {
                console.error('Forget spell error:', error);
                return { success: false, error: 'Network error' };
            }
        }

        // Инициализация при загрузке страницы
        async function init() {
            sessionToken = getSessionToken();
            
            if (!sessionToken) {
                // Нет сессии - перенаправляем на страницу входа
                window.location.href = 'index.html';
                return;
            }

            const userId = await verifySession(sessionToken);
            
            if (!userId) {
                // Сессия невалидна - перенаправляем на страницу входа
                localStorage.removeItem('session_token');
                window.location.href = 'index.html';
                return;
            }

            // Загружаем данные пользователя
            currentUser = await loadUserData(sessionToken);
            
            if (!currentUser) {
                showError();
                return;
            }

            // Загружаем статистику пользователя
            userStats = await loadUserStats(sessionToken);
            
            // Загружаем информацию о слотах заклинаний
            spellSlotsInfo = await loadSpellSlotsInfo(sessionToken);
            
            // Загружаем заклинания
            await loadSpells();
            
            // Отображаем данные
            displayUserData();
            
            // Настраиваем обработчики событий
            setupEventListeners();
        }

        // Загрузка заклинаний
        async function loadSpells() {
            learnedSpells = await loadLearnedSpells(sessionToken);
            availableSpells = await loadAvailableSpells(sessionToken);
        }

        function displayUserData() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // Заголовок с именем пользователя
            document.getElementById('username-header').textContent = currentUser.username;
            
            // Отображаем информацию о слотах заклинаний
            displaySpellSlotsInfo();
            
            // Отображаем изученные заклинания
            displayLearnedSpells();
            
            // Отображаем доступные заклинания
            displayAvailableSpells();
        }

        function displaySpellSlotsInfo() {
            if (spellSlotsInfo && spellSlotsInfo.success) {
                const infoElement = document.getElementById('spell-limit-info');
                const currentElement = document.getElementById('current-spells');
                const maxElement = document.getElementById('max-spells');
                const levelElement = document.getElementById('user-level');
                
                currentElement.textContent = spellSlotsInfo.current_slots;
                maxElement.textContent = spellSlotsInfo.max_slots;
                levelElement.textContent = spellSlotsInfo.user_level;
                infoElement.style.display = 'block';
                
                // Добавляем класс предупреждения, если слоты заполнены
                if (spellSlotsInfo.current_slots >= spellSlotsInfo.max_slots) {
                    infoElement.classList.add('warning');
                }
            }
        }

        function displayLearnedSpells() {
            const container = document.getElementById('learned-spells');
            const emptyState = document.getElementById('no-learned-spells');
            const countElement = document.getElementById('learned-count');
            
            countElement.textContent = learnedSpells.length;
            
            if (learnedSpells.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            learnedSpells.forEach(spell => {
                const spellElement = createSpellElement(spell, true);
                container.appendChild(spellElement);
            });
        }

        function displayAvailableSpells() {
            const container = document.getElementById('available-spells');
            const emptyState = document.getElementById('no-available-spells');
            const countElement = document.getElementById('available-count');
            
            countElement.textContent = availableSpells.length;
            
            if (availableSpells.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            availableSpells.forEach(spell => {
                const spellElement = createSpellElement(spell, false);
                container.appendChild(spellElement);
            });
        }

        function createSpellElement(spell, isLearned) {
            const spellDiv = document.createElement('div');
            
            // Проверяем, находится ли заклинание на кулдауне
            const isOnCooldown = spell.cooldown_until && new Date(spell.cooldown_until) > new Date();
            
            if (isOnCooldown) {
                spellDiv.className = 'spell-card on-cooldown';
            } else {
                spellDiv.className = `spell-card ${isLearned ? 'learned' : 'available'}`;
            }
            
            spellDiv.dataset.spellId = spell.spell_id;
            
            // Определяем иконку в зависимости от типа заклинания
            let spellIcon = 'fa-fire';
            if (spell.atk_type === 'Magic') spellIcon = 'fa-wand-magic-sparkles';
            if (spell.atk_type === 'Physic') spellIcon = 'fa-swords';
            if (spell.atk_type === 'Pure') spellIcon = 'fa-star';
            if (spell.heal > 0) spellIcon = 'fa-heart';
            if (spell.block > 0) spellIcon = 'fa-shield';
            
            // Формируем HTML для карточки заклинания
            let cooldownHTML = '';
            if (isOnCooldown) {
                const availableDate = new Date(spell.cooldown_until);
                const now = new Date();
                const timeLeft = availableDate.getTime() - now.getTime();
                const hoursLeft = Math.ceil(timeLeft / (1000 * 60 * 60));
                cooldownHTML = `<div class="spell-cooldown">Доступно через: ${hoursLeft} ч.</div>`;
            }
            
            spellDiv.innerHTML = `
                <div class="spell-header">
                    <div>
                        <div class="spell-name">${spell.spell_name}</div>
                        <div class="spell-desc">${spell.spell_desc}</div>
                    </div>
                    <div class="spell-level">Ур. ${spell.min_lvl}</div>
                </div>
                
                ${cooldownHTML}
                
                <div class="spell-stats">
                    ${spell.atk > 0 ? `<div class="spell-stat">Урон: ${spell.atk}</div>` : ''}
                    ${spell.heal > 0 ? `<div class="spell-stat">Лечение: ${spell.heal}</div>` : ''}
                    ${spell.block > 0 ? `<div class="spell-stat">Блок: ${spell.block}</div>` : ''}
                    ${spell.mp > 0 ? `<div class="spell-stat">Мана: ${spell.mp}</div>` : ''}
                    <div class="spell-stat">Тип: ${getAttackTypeName(spell.atk_type)}</div>
                </div>
                
                <div class="spell-details">
                    ${spell.effects ? `<div class="detail-row"><span class="detail-label">Эффект:</span><span class="detail-value">${spell.effects}</span></div>` : ''}
                    ${spell.effects_1 ? `<div class="detail-row"><span class="detail-label">Доп. эффект 1:</span><span class="detail-value">${spell.effects_1}</span></div>` : ''}
                    ${spell.effects_2 ? `<div class="detail-row"><span class="detail-label">Доп. эффект 2:</span><span class="detail-value">${spell.effects_2}</span></div>` : ''}
                    ${spell.mp_add > 0 ? `<div class="detail-row"><span class="detail-label">Доп. мана:</span><span class="detail-value">+${spell.mp_add}</span></div>` : ''}
                </div>
                
                ${!isLearned ? 
                    `<div class="spell-actions">
                        <button class="learn-button" data-spell-id="${spell.spell_id}" ${isOnCooldown ? 'disabled' : ''}>
                            ${isOnCooldown ? 'На кулдауне' : 'Изучить'}
                        </button>
                    </div>` : 
                    `<div class="spell-actions">
                        <button class="forget-button" data-spell-id="${spell.spell_id}">Забыть</button>
                    </div>`
                }
            `;
            
            // Добавляем обработчик для раскрытия деталей
            const detailsElement = spellDiv.querySelector('.spell-details');
            spellDiv.addEventListener('click', (e) => {
                if (!e.target.classList.contains('learn-button') && !e.target.classList.contains('forget-button')) {
                    detailsElement.classList.toggle('active');
                }
            });
            
            // Добавляем обработчик для кнопки изучения
            if (!isLearned && !isOnCooldown) {
                const learnButton = spellDiv.querySelector('.learn-button');
                learnButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const spellId = learnButton.dataset.spellId;
                    await handleLearnSpell(spellId);
                });
            } else if (isLearned) {
                // Добавляем обработчик для кнопки забытия
                const forgetButton = spellDiv.querySelector('.forget-button');
                forgetButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const spellId = forgetButton.dataset.spellId;
                    await handleForgetSpell(spellId);
                });
            }
            
            return spellDiv;
        }

        function getAttackTypeName(type) {
            const types = {
                'Magic': 'Магия',
                'Physic': 'Физический',
                'Pure': 'Чистый'
            };
            return types[type] || type;
        }

        async function handleLearnSpell(spellId) {
            // Проверяем, есть ли свободные слоты
            if (spellSlotsInfo && spellSlotsInfo.current_slots >= spellSlotsInfo.max_slots) {
                alert('Нет свободных слотов для заклинаний! Забудьте ненужные заклинания, чтобы освободить место.');
                return;
            }
            
            const result = await learnSpell(spellId);
            
            if (result.success) {
                alert('Заклинание успешно изучено!');
                // Перезагружаем страницу для обновления данных
                location.reload();
            } else {
                if (result.error) {
                    alert(result.error);
                } else {
                    alert('Ошибка при изучении заклинания. Возможно, у вас недостаточный уровень или заклинание уже изучено.');
                }
            }
        }

        async function handleForgetSpell(spellId) {
            const spellName = learnedSpells.find(spell => spell.spell_id == spellId)?.spell_name || 'это заклинание';
            const confirmForget = confirm(`Вы уверены, что хотите забыть заклинание "${spellName}"?\n\nВы не сможете изучить его снова в течение 3 дней.`);
            
            if (!confirmForget) return;
            
            const result = await forgetSpell(spellId);
            
            if (result.success) {
                alert('Заклинание успешно забыто! Вы сможете изучить его снова через 3 дня.');
                // Перезагружаем страницу для обновления данных
                location.reload();
            } else {
                alert('Ошибка при забытии заклинания.');
            }
        }

        function setupEventListeners() {
            // Обработчик для иконки пользователя (переход в профиль)
            document.getElementById('user-icon').addEventListener('click', function() {
                window.location.href = 'account.html';
            });
            
            // Обработчик для иконки дома (переход на главную)
            document.getElementById('home-icon').addEventListener('click', function() {
                window.location.href = 'home.html';
            });
            
            // Обработчик для иконки книги заклинаний (остаемся на странице)
            document.getElementById('spells-icon').addEventListener('click', function() {
                // Уже на странице заклинаний, ничего не делаем
            });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        // Инициализируем при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
