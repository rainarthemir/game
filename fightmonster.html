<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сражение с Монстрами - Игра</title>
    <!-- Подключаем Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B0000 0%, #2F4F4F 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Шапка */
        .header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4a5568;
        }
        
        .logo span {
            color: #8B0000;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-icon, .spells-icon, .monster-icon, .home-icon {
            background: #8B0000;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .home-icon {
            background: #2F4F4F;
        }
        
        .spells-icon {
            background: #357692;
        }
        
        .monster-icon {
            background: #e53e3e;
        }
        
        .user-icon:hover, .spells-icon:hover, .home-icon:hover, .monster-icon:hover {
            transform: scale(1.05);
        }
        
        .username {
            font-weight: 500;
            color: #4a5568;
        }
        
        /* Основное содержимое */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .battle-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 2rem;
            color: #8B0000;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Статус боя */
        .battle-status {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .combatant {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .combatant.player {
            border-left: 5px solid #4CAF50;
        }
        
        .combatant.monster {
            border-left: 5px solid #f44336;
        }
        
        .combatant-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
        }
        
        .health-bar, .mana-bar {
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .mana-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #03A9F4);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .health-text, .mana-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: #2d3748;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
        }
        
        .distance-display {
            text-align: center;
            padding: 20px;
        }
        
        .distance-value {
            font-size: 3rem;
            font-weight: bold;
            color: #8B0000;
            margin: 10px 0;
        }
        
        .distance-label {
            color: #718096;
            font-size: 1.1rem;
        }
        
        /* Действия */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .action-card.movement {
            border-color: #FF9800;
        }
        
        .action-card.meditation {
            border-color: #2196F3;
        }
        
        .action-card.spells {
            border-color: #9C27B0;
        }
        
        .action-title {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-title i {
            font-size: 1.5rem;
        }
        
        .movement-options, .spell-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-button {
            background: linear-gradient(135deg, #8B0000, #DC143C);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
        }
        
        .action-button:active {
            transform: translateY(0);
        }
        
        .action-button.meditate {
            background: linear-gradient(135deg, #2196F3, #03A9F4);
        }
        
        .action-button.meditate:hover {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .spell-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .spell-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .spell-item:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }
        
        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .spell-name {
            font-weight: 600;
            color: #4a5568;
        }
        
        .spell-cost {
            background: #2196F3;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .spell-desc {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .spell-stats {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: #4a5568;
        }
        
        .spell-stat {
            background: white;
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }
        
        /* Лог боя */
        .battle-log {
            background: #1a202c;
            color: white;
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            animation: fadeIn 0.3s ease;
        }
        
        .log-entry.player {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }
        
        .log-entry.monster {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }
        
        .log-entry.system {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
            color: #90cdf4;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Состояния */
        .start-battle-section {
            text-align: center;
            padding: 50px 30px;
        }
        
        .start-button {
            background: linear-gradient(135deg, #8B0000, #DC143C);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(139, 0, 0, 0.3);
            margin: 20px 0;
        }
        
        .start-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(139, 0, 0, 0.4);
        }
        
        .cooldown-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            color: #856404;
        }
        
        .cooldown-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8B0000;
            margin: 10px 0;
        }
        
        .loading {
            padding: 40px;
            color: #666;
            text-align: center;
            background: white;
            border-radius: 15px;
            margin: 20px;
        }
        
        .error {
            padding: 40px;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 10px;
            text-align: center;
            margin: 20px;
        }
        
        .victory-message, .defeat-message {
            text-align: center;
            padding: 40px;
            border-radius: 15px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        .victory-message {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }
        
        .defeat-message {
            background: linear-gradient(135deg, #f44336, #E91E63);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .container {
                padding: 15px;
            }
            
            .username {
                display: none;
            }
            
            .battle-status {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .movement-options, .spell-options {
                grid-template-columns: 1fr;
            }
            
            .user-menu {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="header">
        <div class="logo">Игра<span>Мир</span></div>
        <div class="user-menu">
            <span class="username" id="username-header">Загрузка...</span>
            <div class="home-icon" id="home-icon" title="На главную">
                <i class="fa-solid fa-house"></i>
            </div>
            <div class="spells-icon" id="spells-icon" title="Книга заклинаний">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <div class="monster-icon" id="monster-icon" title="Сражение с монстрами">
                <i class="fa-solid fa-ghost"></i>
            </div>
            <div class="user-icon" id="user-icon" title="Профиль">
                <i class="fa-solid fa-user"></i>
            </div>
        </div>
    </header>

    <!-- Основное содержимое -->
    <div class="container">
        <div id="loading" class="loading">
            <h2>Загрузка боя...</h2>
            <p>Пожалуйста, подождите, загружаем данные о сражении.</p>
        </div>
        
        <!-- Состояние начала боя -->
        <div id="start-battle-state" class="battle-section" style="display: none;">
            <div class="start-battle-section">
                <h1 class="section-title">Сражение с Монстрами</h1>
                <p style="color: #718096; font-size: 1.1rem; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    Испытайте свои силы в эпических сражениях! Побеждайте монстров, получайте опыт и золото, 
                    и становитесь сильнее с каждым боем.
                </p>
                
                <button class="start-button" id="start-battle-button">
                    <i class="fa-solid fa-play" style="margin-right: 10px;"></i>
                    Начать бой
                </button>
                
                <div id="cooldown-info" class="cooldown-info" style="display: none;">
                    <h3><i class="fa-solid fa-clock"></i> Бой пока недоступен</h3>
                    <p>Следующий бой будет доступен через:</p>
                    <div class="cooldown-timer" id="cooldown-timer">00:00</div>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Вы можете сражаться с монстрами один раз в час. 
                        В будущем эта возможность будет расширена!
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Активный бой -->
        <div id="active-battle-state" class="battle-section" style="display: none;">
            <h1 class="section-title" id="battle-title">Сражение с <span id="monster-name">Монстром</span></h1>
            
            <!-- Статус боя -->
            <div class="battle-status">
                <!-- Игрок -->
                <div class="combatant player">
                    <div class="combatant-name" id="player-name">Игрок</div>
                    <div>Уровень: <span id="player-level">1</span></div>
                    <div class="health-bar">
                        <div class="health-fill" id="player-health-fill" style="width: 100%;"></div>
                        <div class="health-text" id="player-health-text">100/100</div>
                    </div>
                    <div class="mana-bar">
                        <div class="mana-fill" id="player-mana-fill" style="width: 100%;"></div>
                        <div class="mana-text" id="player-mana-text">20/20</div>
                    </div>
                    <div>Скорость: <span id="player-speed">1</span></div>
                </div>
                
                <!-- Дистанция -->
                <div class="distance-display">
                    <div class="distance-label">Дистанция</div>
                    <div class="distance-value" id="distance-value">5</div>
                    <div class="distance-label">юнитов</div>
                </div>
                
                <!-- Монстр -->
                <div class="combatant monster">
                    <div class="combatant-name" id="monster-combatant-name">Монстр</div>
                    <div>Уровень: <span id="monster-level">1</span></div>
                    <div class="health-bar">
                        <div class="health-fill" id="monster-health-fill" style="width: 100%;"></div>
                        <div class="health-text" id="monster-health-text">100/100</div>
                    </div>
                    <div class="mana-bar">
                        <div class="mana-fill" id="monster-mana-fill" style="width: 100%;"></div>
                        <div class="mana-text" id="monster-mana-text">0/0</div>
                    </div>
                    <div>Скорость: <span id="monster-speed">1</span></div>
                </div>
            </div>
            
            <!-- Действия -->
            <div class="actions-grid">
                <!-- Движение -->
                <div class="action-card movement">
                    <h3 class="action-title">
                        <i class="fa-solid fa-arrows-left-right" style="color: #FF9800;"></i>
                        Перемещение
                    </h3>
                    <p style="color: #718096; margin-bottom: 15px;">
                        Измените дистанцию до монстра. Ваша скорость: <span id="player-speed-display">1</span>
                    </p>
                    <div class="movement-options">
                        <button class="action-button" id="move-forward-button">
                            <i class="fa-solid fa-arrow-right"></i>
                            Приблизиться
                        </button>
                        <button class="action-button" id="move-backward-button">
                            <i class="fa-solid fa-arrow-left"></i>
                            Отдалиться
                        </button>
                    </div>
                </div>
                
                <!-- Медитация -->
                <div class="action-card meditation">
                    <h3 class="action-title">
                        <i class="fa-solid fa-spa" style="color: #2196F3;"></i>
                        Медитация
                    </h3>
                    <p style="color: #718096; margin-bottom: 15px;">
                        Восстановите ману для использования заклинаний. Восстановление: 5 MP
                    </p>
                    <button class="action-button meditate" id="meditate-button">
                        <i class="fa-solid fa-spa"></i>
                        Медитировать (+5 MP)
                    </button>
                </div>
                
                <!-- Заклинания -->
                <div class="action-card spells">
                    <h3 class="action-title">
                        <i class="fa-solid fa-wand-magic-sparkles" style="color: #9C27B0;"></i>
                        Заклинания
                    </h3>
                    <p style="color: #718096; margin-bottom: 15px;">
                        Используйте изученные заклинания для нанесения урона или применения эффектов.
                    </p>
                    <div class="spell-list" id="spell-list">
                        <!-- Список заклинаний будет загружен здесь -->
                    </div>
                </div>
            </div>
            
            <!-- Лог боя -->
            <div class="battle-log" id="battle-log">
                <div class="log-entry system">Бой начался! Выберите действие.</div>
            </div>
        </div>
        
        <!-- Результат боя -->
        <div id="battle-result-state" style="display: none;">
            <div class="victory-message" id="victory-message" style="display: none;">
                <h1><i class="fa-solid fa-trophy"></i> Победа!</h1>
                <p style="font-size: 1.2rem; margin: 20px 0;">
                    Вы победили <span id="defeated-monster-name">монстра</span>!
                </p>
                <div style="font-size: 1.1rem;">
                    <p>Получено опыта: <span id="xp-gained">0</span></p>
                    <p>Получено золота: <span id="gold-gained">0</span></p>
                </div>
                <button class="start-button" id="new-battle-button" style="margin-top: 30px;">
                    <i class="fa-solid fa-redo"></i>
                    Новый бой
                </button>
            </div>
            
            <div class="defeat-message" id="defeat-message" style="display: none;">
                <h1><i class="fa-solid fa-skull"></i> Поражение</h1>
                <p style="font-size: 1.2rem; margin: 20px 0;">
                    Вы были побеждены <span id="victorious-monster-name">монстром</span>.
                </p>
                <p style="font-size: 1.1rem;">
                    Не отчаивайтесь! Подготовьтесь лучше к следующему бою.
                </p>
                <button class="start-button" id="retry-battle-button" style="margin-top: 30px;">
                    <i class="fa-solid fa-redo"></i>
                    Попробовать снова
                </button>
            </div>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <h2>Ошибка загрузки</h2>
            <p>Не удалось загрузить данные о бое.</p>
            <p>Попробуйте <a href="javascript:location.reload()">обновить страницу</a> или <a href="home.html">вернуться на главную</a>.</p>
        </div>
    </div>

    <script>
        let sessionToken = null;
        let currentBattle = null;
        let userSpells = [];
        let cooldownTimer = null;

        // Получаем токен сессии из localStorage
        function getSessionToken() {
            return localStorage.getItem('session_token');
        }

        // Проверяем валидность сессии
        async function verifySession(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/session/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.valid ? data.user_id : null;
                }
                return null;
            } catch (error) {
                console.error('Session verification error:', error);
                return null;
            }
        }

        // Загружаем данные пользователя
        async function loadUserData(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('User data loading error:', error);
                return null;
            }
        }

        // Загружаем заклинания пользователя
        async function loadUserSpells(token) {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/user/spells', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.success ? data.spells : [];
                }
                return [];
            } catch (error) {
                console.error('User spells loading error:', error);
                return [];
            }
        }

        // Начать новый бой
        async function startBattle() {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/battle/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.battle;
                } else {
                    throw new Error(data.error || 'Failed to start battle');
                }
            } catch (error) {
                console.error('Start battle error:', error);
                throw error;
            }
        }

        // Получить статус текущего боя
        async function getBattleStatus() {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/battle/status', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.success ? data.battle : null;
                }
                return null;
            } catch (error) {
                console.error('Battle status error:', error);
                return null;
            }
        }

        // Выполнить действие в бою
        async function performBattleAction(actionType, value = null) {
            try {
                const body = { action_type: actionType };
                if (value !== null) {
                    body.value = value;
                }

                console.log('Sending battle action:', body);

                const response = await fetch('https://game.dmytrothemir.workers.dev/api/battle/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                console.log('Battle action response:', data);
                
                if (data.success) {
                    return data.result;
                } else {
                    throw new Error(data.error || 'Failed to perform action');
                }
            } catch (error) {
                console.error('Battle action error:', error);
                throw error;
            }
        }

        // Получить информацию о кулдауне
        async function getBattleCooldown() {
            try {
                const response = await fetch('https://game.dmytrothemir.workers.dev/api/battle/cooldown', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
                return null;
            } catch (error) {
                console.error('Battle cooldown error:', error);
                return null;
            }
        }

        // Инициализация при загрузке страницы
        async function init() {
            sessionToken = getSessionToken();
            
            if (!sessionToken) {
                // Нет сессии - перенаправляем на страницу входа
                window.location.href = 'index.html';
                return;
            }

            const userId = await verifySession(sessionToken);
            
            if (!userId) {
                // Сессия невалидна - перенаправляем на страницу входа
                localStorage.removeItem('session_token');
                window.location.href = 'index.html';
                return;
            }

            // Загружаем данные пользователя
            const currentUser = await loadUserData(sessionToken);
            
            if (!currentUser) {
                showError();
                return;
            }

            // Загружаем заклинания пользователя
            userSpells = await loadUserSpells(sessionToken);
            
            // Отображаем имя пользователя
            document.getElementById('username-header').textContent = currentUser.username;
            
            // Проверяем состояние боя
            await checkBattleState();
            
            // Настраиваем обработчики событий
            setupEventListeners();
        }

        // Проверяем состояние боя
        async function checkBattleState() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('start-battle-state').style.display = 'none';
            document.getElementById('active-battle-state').style.display = 'none';
            document.getElementById('battle-result-state').style.display = 'none';

            // Проверяем активный бой
            currentBattle = await getBattleStatus();
            
            if (currentBattle) {
                // Есть активный бой
                displayActiveBattle();
            } else {
                // Нет активного боя - проверяем кулдаун
                const cooldownInfo = await getBattleCooldown();
                
                if (cooldownInfo && cooldownInfo.success) {
                    if (cooldownInfo.can_fight) {
                        // Можно начать бой
                        displayStartBattleState();
                    } else {
                        // Показываем кулдаун
                        displayCooldownState(cooldownInfo.cooldown_remaining);
                    }
                } else {
                    displayStartBattleState();
                }
            }
            
            document.getElementById('loading').style.display = 'none';
        }

        // Отображаем состояние начала боя
        function displayStartBattleState() {
            document.getElementById('start-battle-state').style.display = 'block';
        }

        // Отображаем состояние кулдауна
        function displayCooldownState(minutesRemaining) {
            document.getElementById('start-battle-state').style.display = 'block';
            document.getElementById('cooldown-info').style.display = 'block';
            
            // Запускаем таймер
            let secondsRemaining = minutesRemaining * 60;
            updateCooldownTimer(secondsRemaining);
            
            cooldownTimer = setInterval(() => {
                secondsRemaining--;
                if (secondsRemaining <= 0) {
                    clearInterval(cooldownTimer);
                    document.getElementById('cooldown-info').style.display = 'none';
                } else {
                    updateCooldownTimer(secondsRemaining);
                }
            }, 1000);
        }

        // Обновляем таймер кулдауна
        function updateCooldownTimer(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const timerText = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            document.getElementById('cooldown-timer').textContent = timerText;
        }

        // Отображаем активный бой
        function displayActiveBattle() {
            document.getElementById('active-battle-state').style.display = 'block';
            
            // Обновляем информацию о бое
            updateBattleDisplay();
            
            // Загружаем список заклинаний
            displaySpellList();
        }

        // Обновляем отображение боя
        function updateBattleDisplay() {
            if (!currentBattle) return;

            // Обновляем информацию о монстре
            document.getElementById('monster-name').textContent = currentBattle.name;
            document.getElementById('monster-combatant-name').textContent = currentBattle.name;
            document.getElementById('monster-level').textContent = currentBattle.lvl;
            document.getElementById('monster-speed').textContent = currentBattle.speed;

            // Обновляем здоровье и ману монстра
            const monsterHealthPercent = (currentBattle.monster_hp / currentBattle.max_hp) * 100;
            document.getElementById('monster-health-fill').style.width = `${monsterHealthPercent}%`;
            document.getElementById('monster-health-text').textContent = `${currentBattle.monster_hp}/${currentBattle.max_hp}`;

            const monsterManaPercent = currentBattle.max_mp ? (currentBattle.monster_mp / currentBattle.max_mp) * 100 : 0;
            document.getElementById('monster-mana-fill').style.width = `${monsterManaPercent}%`;
            document.getElementById('monster-mana-text').textContent = currentBattle.max_mp ? 
                `${currentBattle.monster_mp}/${currentBattle.max_mp}` : '0/0';

            // Обновляем здоровье и ману игрока
            const playerHealthPercent = (currentBattle.user_hp / currentBattle.user_max_hp) * 100;
            document.getElementById('player-health-fill').style.width = `${playerHealthPercent}%`;
            document.getElementById('player-health-text').textContent = `${currentBattle.user_hp}/${currentBattle.user_max_hp}`;

            const playerManaPercent = (currentBattle.user_mp / currentBattle.user_max_mp) * 100;
            document.getElementById('player-mana-fill').style.width = `${playerManaPercent}%`;
            document.getElementById('player-mana-text').textContent = `${currentBattle.user_mp}/${currentBattle.user_max_mp}`;

            // Обновляем скорость игрока
            document.getElementById('player-speed').textContent = currentBattle.speed;
            document.getElementById('player-speed-display').textContent = currentBattle.speed;

            // Обновляем дистанцию
            document.getElementById('distance-value').textContent = currentBattle.distance;

            // Обновляем уровень игрока
            document.getElementById('player-level').textContent = currentBattle.lvl;
        }

        // Отображаем список заклинаний
        function displaySpellList() {
            const spellList = document.getElementById('spell-list');
            spellList.innerHTML = '';

            if (userSpells.length === 0) {
                spellList.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">Нет изученных заклинаний</div>';
                return;
            }

            userSpells.forEach(spell => {
                const spellItem = document.createElement('div');
                spellItem.className = 'spell-item';
                spellItem.dataset.spellId = spell.spell_id;
                
                spellItem.innerHTML = `
                    <div class="spell-header">
                        <div class="spell-name">${spell.spell_name}</div>
                        <div class="spell-cost">${spell.mp} MP</div>
                    </div>
                    <div class="spell-desc">${spell.spell_desc}</div>
                    <div class="spell-stats">
                        ${spell.atk > 0 ? `<div class="spell-stat">Урон: ${spell.atk}</div>` : ''}
                        ${spell.heal > 0 ? `<div class="spell-stat">Лечение: ${spell.heal}</div>` : ''}
                        <div class="spell-stat">Тип: ${getAttackTypeName(spell.atk_type)}</div>
                    </div>
                `;

                // Добавляем обработчик клика
                spellItem.addEventListener('click', () => {
                    useSpell(spell.spell_id);
                });

                spellList.appendChild(spellItem);
            });
        }

        // Использовать заклинание
        async function useSpell(spellId) {
            try {
                const result = await performBattleAction('spell', spellId);
                processBattleResult(result);
            } catch (error) {
                addLogEntry(`Ошибка: ${error.message}`, 'system');
            }
        }

        // Обрабатываем результат боя
        function processBattleResult(result) {
            console.log('Processing battle result:', result);
            
            // Добавляем действие игрока в лог
            if (result.user_action && result.user_action.message) {
                addLogEntry(result.user_action.message, 'player');
            }

            // Обновляем состояние боя на основе действия игрока
            updateBattleFromAction(result.user_action);

            // Если бой продолжается, добавляем действие монстра
            if (!result.battle_ended && result.monster_action) {
                setTimeout(() => {
                    if (result.monster_action.message) {
                        addLogEntry(result.monster_action.message, 'monster');
                    }

                    // Обновляем состояние после действия монстра
                    updateBattleFromAction(result.monster_action);

                    // Проверяем окончание боя после хода монстра
                    if (result.monster_action.battle_ended) {
                        displayBattleResult(result.winner);
                    }
                }, 1000);
            } else if (result.battle_ended) {
                // Бой окончен действием игрока
                displayBattleResult(result.winner);
            }
        }

        // Обновляем состояние боя на основе действия
        function updateBattleFromAction(action) {
            if (!action || !currentBattle) return;

            if (action.new_monster_hp !== undefined) {
                currentBattle.monster_hp = action.new_monster_hp;
            }
            if (action.new_user_mp !== undefined) {
                currentBattle.user_mp = action.new_user_mp;
            }
            if (action.new_user_hp !== undefined) {
                currentBattle.user_hp = action.new_user_hp;
            }
            if (action.new_monster_mp !== undefined) {
                currentBattle.monster_mp = action.new_monster_mp;
            }
            if (action.new_distance !== undefined) {
                currentBattle.distance = action.new_distance;
            }

            // Обновляем отображение
            updateBattleDisplay();
        }

        // Отображаем результат боя
        function displayBattleResult(winner) {
            document.getElementById('active-battle-state').style.display = 'none';
            document.getElementById('battle-result-state').style.display = 'block';

            if (winner === 'user') {
                document.getElementById('victory-message').style.display = 'block';
                document.getElementById('defeated-monster-name').textContent = currentBattle.name;
                // Здесь можно добавить получение информации о наградах
            } else {
                document.getElementById('defeat-message').style.display = 'block';
                document.getElementById('victorious-monster-name').textContent = currentBattle.name;
            }
        }

        // Добавляем запись в лог боя
        function addLogEntry(message, type) {
            const log = document.getElementById('battle-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = message;
            
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Получаем название типа атаки
        function getAttackTypeName(type) {
            const types = {
                'Magic': 'Магия',
                'Physic': 'Физический',
                'Pure': 'Чистый'
            };
            return types[type] || type;
        }

        // Настраиваем обработчики событий
        function setupEventListeners() {
            // Обработчик для иконки пользователя (переход в профиль)
            document.getElementById('user-icon').addEventListener('click', function() {
                window.location.href = 'account.html';
            });
            
            // Обработчик для иконки дома (переход на главную)
            document.getElementById('home-icon').addEventListener('click', function() {
                window.location.href = 'home.html';
            });
            
            // Обработчик для иконки книги заклинаний
            document.getElementById('spells-icon').addEventListener('click', function() {
                window.location.href = 'spells.html';
            });
            
            // Обработчик для иконки призрака (остаемся на странице)
            document.getElementById('monster-icon').addEventListener('click', function() {
                // Уже на странице боев, ничего не делаем
            });
            
            // Обработчик для кнопки "Начать бой"
            document.getElementById('start-battle-button').addEventListener('click', async function() {
                try {
                    document.getElementById('loading').style.display = 'block';
                    currentBattle = await startBattle();
                    displayActiveBattle();
                    addLogEntry(`Бой с ${currentBattle.name} начался!`, 'system');
                } catch (error) {
                    alert(`Ошибка начала боя: ${error.message}`);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            // Обработчики для перемещения
            document.getElementById('move-forward-button').addEventListener('click', async function() {
                try {
                    const result = await performBattleAction('move', -1); // Приблизиться
                    processBattleResult(result);
                } catch (error) {
                    addLogEntry(`Ошибка: ${error.message}`, 'system');
                }
            });
            
            document.getElementById('move-backward-button').addEventListener('click', async function() {
                try {
                    const result = await performBattleAction('move', 1); // Отдалиться
                    processBattleResult(result);
                } catch (error) {
                    addLogEntry(`Ошибка: ${error.message}`, 'system');
                }
            });
            
            // Обработчик для медитации
            document.getElementById('meditate-button').addEventListener('click', async function() {
                try {
                    // Медитация - восстанавливаем ману
                    const result = await performBattleAction('meditate');
                    processBattleResult(result);
                } catch (error) {
                    addLogEntry(`Ошибка: ${error.message}`, 'system');
                }
            });
            
            // Обработчики для кнопок результатов боя
            document.getElementById('new-battle-button').addEventListener('click', function() {
                location.reload();
            });
            
            document.getElementById('retry-battle-button').addEventListener('click', function() {
                location.reload();
            });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        // Инициализируем при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
